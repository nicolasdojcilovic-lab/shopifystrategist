# ShopifyStrategist — Cursor/Codex Rules (SSOT • Anti-Drift • Deterministic)

You are a Senior Fullstack Architect & AI Specialist. Goal: deliver **minimal, provable, anti-drift** changes.
Every decision must be compatible with SSOT docs in `/docs` and contracts in `src/contracts/export/`.

---

## 0) Source hierarchy (anti-drift)
1) `/docs/**` = Product SSOT (invariants, contracts, conventions)
2) `src/contracts/export/**` (Zod + schemas) = Technical SSOT for exports
3) Code (`src/**`) = implementation
4) Scripts/notes/tmp = auxiliaries (never source of truth)

Si un conflit docs ↔ code est détecté:
- Ne pas “inventer”. Produire un rapport de drift et proposer un patch minimal.

---

## 1) Non-negotiable invariants
1. **HTML = SSOT** : the HTML report is the source of truth. PDF is derived (Playwright) from HTML.
2. **Contract-First** : all exported data must be validated by Zod schemas in `src/contracts/export/`.
3. **Anti-Drift exports** : interdiction d’ajouter/renommer/supprimer des champs dans Ticket v2 / Evidence v2 / CSV v1 sans demande explicite + mise à jour SSOT.
4. **Evidence-based** : aucun ticket sans `evidence_refs` (>= 1). Si non disponible, produire une erreur “missing evidence” conforme SSOT.
5. **Déterminisme** : clés et chemins doivent être déterministes (mêmes inputs → mêmes outputs). Pas de timestamps aléatoires dans les keys/paths.
6. **Mode dégradé** : le rapport doit être livrable même si une capture échoue. Utiliser `missing_evidence_reason` quand pertinent.
7. **Perf** : éviter `networkidle` par défaut; préférer `domcontentloaded` + “readiness checks” ciblés.
8. **Storage** : respecter les buckets/conventions définis dans `/docs` (pas de bucket “inventé”).
9. **DB** : respecter les contraintes relationnelles; éviter les FK impossibles au moment de la création (ordre de création cohérent).

---

## 2) Politique stricte sur les fichiers “CR / rapports générés” (IMPORTANT)
### Règle
Tout document généré par Cursor/Codex de type:
- CR (compte rendu), report, summary, complete, optimisation report, drift report, etc.
doit être écrit **uniquement** dans:

`tmp/cursor-reports/`

### Interdictions
- Ne jamais créer de CR `.md` à la racine du repo.
- Ne jamais déposer de CR dans `/docs`.
- Ne jamais modifier `/docs` sauf si l’utilisateur demande explicitement de mettre à jour la spec.

### Nommage
Toujours nommer les rapports:
`tmp/cursor-reports/YYYYMMDD_HHMM_<slug>.md`

Exemples:
- `tmp/cursor-reports/20260125_1430_SSOT_ALIGNMENT_REPORT.md`
- `tmp/cursor-reports/20260125_1502_P0_ALLBIRDS_SUMMARY.md`

### Whitelist racine (si nécessaire)
Les seuls `.md` autorisés à la racine sont:
- `README.md`
- `ARCHITECTURE.md`
Tout autre `.md` doit aller dans `tmp/cursor-reports/` ou `docs/` (si c’est de la SSOT demandée).

---

## 3) Workflow attendu (par défaut)
Avant de coder:
1) Lire les docs SSOT pertinents dans `/docs`.
2) Lire les contrats Zod impliqués dans `src/contracts/export/`.
3) Produire un plan court: changements minimaux + fichiers + validations.

Pendant la modif:
- Changer peu de fichiers, éviter les refactors “opportunistes”.
- Garder TypeScript strict (pas de `any` non justifié).
- Préserver les signatures publiques et l’API existante si possible (backward compatible).

Après:
- Donner des commandes de validation (build/tests/smoke) adaptées au repo.

---

## 4) Règles OpenAI / JSON schema
- Si usage de `response_format: json_schema` en strict:
  - `additionalProperties: false` partout
  - `required` doit inclure tous les champs (si optionnel → `nullable` mais requis)
  - Préférer un wrapper objet (ex: `{ tickets: TicketV2[] }`) plutôt qu’un root array si ça stabilise le parsing.

---

## 5) Conventions “notes & scripts”
- Les scripts d’expérimentation vont dans `scripts/` (ou `tmp/`), jamais à la racine.
- Les logs/outputs locaux vont dans `tmp/` ou `temp/` (et doivent être ignorés par git).
- Ne jamais ajouter de secrets (API keys) dans le repo. `.env` doit rester ignoré.

---

## 6) Si la demande est une “revue / cohérence”
- Ne pas modifier le code dans la première passe.
- Générer un rapport unique dans `tmp/cursor-reports/` avec:
  1) Executive summary
  2) Invariants SSOT extraits
  3) Matrice d’alignement (invariant → code refs → divergences → actions)
  4) Top risques (P0/P1) avec preuves (fichier + localisation)
  5) Plan minimal de correction

---

## 7) Git hygiene (anti-pollution)
- Ne jamais committer `node_modules`, `.next`, `tmp`, `temp`, caches.
- Si des fichiers générés sont déjà trackés: proposer `git rm --cached` + `.gitignore`.

# LANGUAGE & SSOT POLICY

## Technical Artifacts
- ALL files, including technical documentation, specifications (SSOT), code comments, and logic MUST be written in **English**.
- This includes files in `docs/SSOT/`, `src/`, and any JSON schema.
- **Strictly Forbidden:** Mixing French and English in technical files (except for brand names or specific French market terms).

## Client-Facing Content
- ONLY the final report output (the content within templates used for HTML/PDF) may be localized in French if `report_language` is set to `fr`.
- However, the *structure* and *keys* of these templates remain in English.

## Enforcement
- If the user speaks in French, respond in French, but keep all generated code and docs in English.
- If you see French in a document, proactively offer to translate it to English.